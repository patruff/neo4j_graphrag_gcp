#cloud-config
package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release

write_files:
  - path: /opt/neo4j/docker-compose.yml
    permissions: '0644'
    content: |
      version: '3.8'

      services:
        neo4j:
          image: neo4j:5.15.0-community
          container_name: neo4j-graphrag
          restart: unless-stopped
          ports:
            - "7474:7474"  # HTTP
            - "7687:7687"  # Bolt
          environment:
            - NEO4J_AUTH=neo4j/${neo4j_password}
            - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
            # Memory settings optimized for GCP e2-micro (1GB RAM)
            - NEO4J_server_memory_heap_initial__size=128m
            - NEO4J_server_memory_heap_max__size=256m
            - NEO4J_server_memory_pagecache_size=256m
            - NEO4J_dbms_security_procedures_unrestricted=apoc.*
            - NEO4J_dbms_security_procedures_allowlist=apoc.*
          volumes:
            - neo4j_data:/data
            - neo4j_logs:/logs
            - neo4j_import:/var/lib/neo4j/import
            - neo4j_plugins:/plugins
          healthcheck:
            test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
            interval: 30s
            timeout: 10s
            retries: 5
            start_period: 60s

      volumes:
        neo4j_data:
          driver: local
        neo4j_logs:
          driver: local
        neo4j_import:
          driver: local
        neo4j_plugins:
          driver: local

runcmd:
  # Install Docker
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
  - systemctl enable docker
  - systemctl start docker

  # Create docker group and add default user
  - usermod -aG docker ubuntu || true

  # Deploy Neo4j using Docker Compose
  - cd /opt/neo4j
  - docker compose up -d

  # Wait for Neo4j to be healthy
  - sleep 60

  # Create success marker
  - echo "Neo4j GraphRAG POC deployment completed at $(date)" > /opt/neo4j/deployment_complete.txt

final_message: "Neo4j GraphRAG POC system is ready. Deployment completed in $UPTIME seconds."
